rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // =========================================================================
    // Helper Functions
    // =========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the authenticated user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user has admin role
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }

    // Check if user has moderator role (includes admin)
    function isModerator() {
      return isAuthenticated() &&
        (request.auth.token.role == 'admin' || request.auth.token.role == 'moderator');
    }

    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Validate field is a string with max length
    function isValidString(field, maxLength) {
      return request.resource.data[field] is string &&
        request.resource.data[field].size() <= maxLength;
    }

    // Validate timestamps are server-generated
    function hasValidTimestamps() {
      return request.resource.data.createdAt == request.time &&
        request.resource.data.updatedAt == request.time;
    }

    // Validate only updatedAt changes for updates
    function hasValidUpdateTimestamp() {
      return request.resource.data.updatedAt == request.time &&
        request.resource.data.createdAt == resource.data.createdAt;
    }

    // =========================================================================
    // User Documents
    // =========================================================================

    // User profiles - users can only read/write their own
    match /users/{userId} {
      allow read: if isOwner(userId);

      allow create: if isOwner(userId) &&
        hasRequiredFields(['email', 'createdAt', 'updatedAt']) &&
        hasValidTimestamps();

      allow update: if isOwner(userId) &&
        hasValidUpdateTimestamp() &&
        // Cannot change email or createdAt
        request.resource.data.email == resource.data.email &&
        request.resource.data.createdAt == resource.data.createdAt;

      allow delete: if isOwner(userId);
    }

    // =========================================================================
    // Generic User-Owned Documents
    // =========================================================================

    // Documents owned by users
    match /documents/{docId} {
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasRequiredFields(['userId', 'title', 'createdAt', 'updatedAt']) &&
        hasValidTimestamps() &&
        isValidString('title', 200);

      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId &&
        hasValidUpdateTimestamp();

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // =========================================================================
    // Admin-Only Access
    // =========================================================================

    match /adminSettings/{docId} {
      allow read, write: if isAdmin();
    }

    // =========================================================================
    // Default: Deny All
    // =========================================================================

    // Deny access to any other collections not explicitly defined
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
